import{provide as e,toRefs as o,useAttrs as t,ref as n,toRaw as r,onUnmounted as c,nextTick as s,openBlock as u,createElementBlock as l,normalizeClass as i,unref as a,normalizeStyle as p,renderSlot as f,Fragment as m,renderList as d,inject as y,watch as g,onMounted as k,onUpdated as v,h as j,resolveComponent as S,createBlock as b,withCtx as w}from"vue";import*as h from"@joskii/jflow-core";import O from"@joskii/jflow-core";function L(o){e("addToStack",(function(e,t){o.addToStack(e),t&&e._jflow.setRenderNodeBySource(t,e)})),e("removeFromStack",(function(e){o.removeFromStack(e)}))}function _(e,o){Object.keys(o).map((t=>{if(/^on[A-Z]/.test(t)){let r=o[t];if(Array.isArray(r)&&(r=r.find((e=>"[object Function]"===Object.toString.call(e)))),r){const o=/^on(.*)/.exec(t);o[1]&&e.addEventListener((n=o[1]).charAt(0).toLowerCase()+n.slice(1),r)}}var n}))}const F={key:1};var C=Object.assign({inheritAttrs:!1},{__name:"JFlow",props:{configs:{type:Object,default:function(){return{}}},loading:Boolean,genVueComponentKey:{type:Function}},emits:["update:loading"],setup(y,{expose:g,emit:k}){const v=y,{genVueComponentKey:j}=o(v),S=t(),b=S.class,w=S.style,h=n(null),C=n([]),$=n([]),N=new O(r(v.configs));L(N),function(o){e("addToLinkStack",(function(e,t,n){o.addToLinkStack(e),t&&n&&o.addLinkNodeBySource(t,n,e)})),e("removeFromLinkStack",(function(e,t,n){o.removeFromLinkStack(e),t&&n&&o.removeLinkNodeBySource(t,n,e)}))}(N);const T=()=>[N._layout.flowStack.map((e=>{const{type:o,layoutNode:t,source:n}=e,r=N.source_Layout_Render_NodeMap;let c;return c=r.has(n)?r.get(n):r.set(n),c.layoutNode=t,e})),N._layout.flowLinkStack.slice()];c((()=>{N?.destroy()}));const x=(e,o)=>{C.value=e.slice(),$.value=o.slice()};x(...T()),s((()=>{console.log(C),N.$mount(h.value),_(N,S),k("update:loading",!1)}));const G=()=>N,B=(()=>{let e=!1;return()=>{e||(e=!0,s((()=>{N._render(),e=!1})))}})();return e("getJFlow",G),e("renderJFlow",B),g({reflow:(e,o)=>{x(...T()),s((()=>{e&&e(),N.recalculate(),N.scheduleRender((()=>{o&&o()}))}))},renderJFlow:B,getInstance:G}),(e,o)=>(u(),l("div",{ref_key:"root",ref:h,class:i(a(b)),style:p(a(w))},[C.value.length?(u(),l("div",F,[(u(!0),l(m,null,d(C.value,(o=>f(e.$slots,o.type,{key:a(j)(o.source),source:o.source,layoutNode:o.layoutNode}))),128)),(u(!0),l(m,null,d($.value,(o=>{return f(e.$slots,o.type||"plainlink",{key:(t=o,`${v.genVueComponentKey(t.from.source)}-${v.genVueComponentKey(t.to.source)}-${t.part}`),configs:o});var t})),128))])):f(e.$slots,"default",{key:0})],6))}});function $(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function N(){return T(null,[].slice.call(arguments,0))}function T(e,o){for(var t,n,r,c,s,u=o.length,l=o[0],i={},a=e&&e.equal||x,p=1;p<u;p++)for(t=o[p],r=(n=Object.keys(t)).length,s=0;s<r;s++)a(t[c=n[s]],l[c])||(i[c]=t[c]);return i}function x(e,o){return e===o}C.__file="components/JFlow.vue",N.custom=function(e){return T(e,[].slice.call(arguments,1))};var G=$(N);function B(e){const o="string"==typeof e?h[e]:e;return{inheritAttrs:!1,props:{configs:{type:Object,default:function(){return{}}},visible:{type:Boolean,default:!0},source:{type:Object}},setup(e,{attrs:t}){const n=y("addToStack"),s=y("removeFromStack"),u=new o(e.configs);return _(u,t),n(u,r(e.source)),g((()=>e.configs),((e,o)=>{const t=G(e,o);0!==Object.keys(t).length&&u.setConfig(e)})),g((()=>e.visible),(e=>{u.visible=e})),g((()=>e.source),(e=>{u._jflow.setRenderNodeBySource(e,u)})),c((()=>{u.destroy(),s(u)})),()=>null}}}function J(e){const o="string"==typeof e?h[e]:e;return{inheritAttrs:!1,props:{configs:{type:Object,default:function(){return{}}},from:Object,to:Object},setup(e,{attrs:t}){const n=y("addToLinkStack"),s=y("removeFromLinkStack"),u=y("getJFlow")();let l;const i=()=>{const c=u.getRenderNodeBySource(r(e.from)),s=u.getRenderNodeBySource(r(e.to));l?l.setConfig({...e.configs,from:c,to:s}):((c,s)=>{c&&s&&(l=new o({...e.configs,from:c,to:s}),_(l,t),n(l,r(e.from),r(e.to)))})(c,s)};i();const a=g((()=>[e.from,e.to,e.configs]),(()=>{i()}));return c((()=>{a(),l&&(l.destroy(),s(l))})),()=>null}}}function V(e){const o="string"==typeof e?h[e]:e;return{inheritAttrs:!1,props:{configs:{type:Object,default:function(){return{}}},visible:{type:Boolean,default:!0},source:{type:Object}},setup(e,{slots:t,attrs:n}){const s=y("addToStack"),u=y("removeFromStack"),l=new o(e.configs);L(l),_(l,n),s(l,r(e.source));const i=g((()=>e.configs),((e,o)=>{JSON.stringify(e)!==JSON.stringify(o)&&l.setConfig(e)})),a=g((()=>e.visible),(e=>{l.visible=e})),p=g((()=>e.source),(e=>{l._jflow.setRenderNodeBySource(e,l)}));return k((()=>{l.recalculate()})),v((()=>{l.recalculateUp()})),c((()=>{i(),a(),p(),l.destroy(),u(l)})),()=>j("jflow-group",t.default())}}}var R=Object.assign({inheritAttrs:!1},{__name:"JFlowTextGroup",props:{configs:{type:Object,default:function(){return{}}},visible:{type:Boolean,default:!0},source:{type:Object},genVueComponentKey:{type:Function}},setup(e,{expose:i}){const p=e,{genVueComponentKey:j}=o(p),h=n([]),O=t(),F=y("addToStack"),C=y("removeFromStack"),$=new TextGroup(r(p.configs));L($),_($,O),F($,r(p.source));const N=()=>{h.value=$._flattenTxtElem.filter((e=>"text"!==e.type))};N();const T=g((()=>p.configs),((e,o)=>{JSON.stringify(e)!==JSON.stringify(o)&&$.setConfig(e)})),x=g((()=>p.visible),(e=>{$.visible=e})),G=g((()=>p.source),(e=>{$._jflow.setRenderNodeBySource(e,$)}));k((()=>{$.recalculate()})),v((()=>{$.recalculateUp()})),c((()=>{T(),x(),G(),$.destroy(),C($)}));return i({reflow:()=>{$.refreshTextElements(),N(),s((()=>{$.refresh()}))},getInstance:()=>$}),(e,o)=>{const t=S("jflow-group");return u(),b(t,null,{default:w((()=>[(u(!0),l(m,null,d(h.value,(o=>f(e.$slots,o.type||"jflowcommon",{key:a(j)(o.source),source:o.source,textElement:o}))),128))])),_:3})}}});function E(e){return{inheritAttrs:!1,props:{configs:{type:Object,default:function(){return{}}},visible:{type:Boolean,default:!0},source:{type:Object},genVueComponentKey:{type:Function}},data:()=>({renderLinks:[]}),setup(o,{attrs:t}){const n=y("addToStack"),s=y("removeFromStack"),u=new e(o.configs);L(u),_(u,t),n(u,r(o.source));(()=>{this.renderLinks=u._layout.flowLinkStack.slice()})();const l=g((()=>o.visible),(e=>{u.visible=e})),i=g((()=>o.source),(e=>{u._jflow.setRenderNodeBySource(e,u)}));k((()=>{u.recalculate()})),v((()=>{u.recalculateUp()})),c((()=>{l(),i(),u.destroy(),s(u)}))},methods:{genLinkVueComponentKey(e){return`${this.genVueComponentKey(e.from.source)}-${this.genVueComponentKey(e.to.source)}-${e.part}`}},template:'\n            <jflow-group>\n                <slot></slot>\n                <template v-for="link in renderLinks" :key="genLinkVueComponentKey(link)">\n                    <slot :name="link.type || \'plainlink\'" \n                        :configs="link">\n                    </slot>\n                </template>\n            </jflow-group>\n        '}}R.__file="components/JFlowTextGroup.vue";const K=[{name:"Jflow",component:C},{name:"Group",component:V("Group")},...["CapsuleGroup","CapsuleVerticalGroup","DiamondGroup","DiamondVerticalGroup","RhombusGroup","PointGroup","ScrollGroup"].map((e=>({name:e,component:V(e)}))),...["Point","Rectangle","Capsule","Diamond","Rhombus","Text","Icon","ShadowDom","TextEditor"].map((e=>({name:e,component:B(e)}))),...["Link","PolyLink","BezierLink"].map((e=>({name:e,component:J(e)}))),{name:"TextGroup",component:R}];customElements.define("jflow-group",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}});const A={install:(e,o={})=>{let t="j";o&&o.prefix&&(t=o.prefix),K.forEach((o=>{e.component(`${t}${o.name}`,o.component)})),o.customInstance&&Object.keys(o.customInstance).forEach((n=>{e.component(`${t}${n}`,B(o.customInstance[n]))})),o.customGroups&&Object.keys(o.customGroups).forEach((n=>{e.component(`${t}${n}`,V(o.customGroups[n]))})),o.customLink&&Object.keys(o.customLink).forEach((n=>{e.component(`${t}${n}`,J(o.customLink[n]))}))}};export{E as JFlowLinkGroup,A as JFlowVuePlugin};
//# sourceMappingURL=jflow-vue3-plugin.es.min.js.map
